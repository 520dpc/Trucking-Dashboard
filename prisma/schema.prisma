generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                          String                       @id @default(uuid())
  name                        String
  dotNumber                   String?
  mcNumber                    String?
  defaultDaysToPay            Int?
  expandThreshold             Int?
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  defaultCurrency             String?
  defaultFuelMpg              Float?
  defaultTruckFixedCostPerDay Int?
  timezone                    String?
  callNotes                   CallNote[]
  contacts                    Contact[]
  customers                   Customer[]
  dashboardLayouts            DashboardWidgetLayout[]
  documents                   Document[]
  drivers                     Driver[]
  emailLogs                   EmailLog[]
  emailTemplates              EmailTemplate[]
  expansionSnapshots          ExpansionReadinessSnapshot[]
  expenses                    Expense[]
  invoices                    Invoice[]
  loads                       Load[]
  locations                   Location[]
  metricSnapshots             MetricSnapshot[]
  payments                    Payment[]
  tasks                       Task[]
  trailers                    Trailer[]
  trucks                      Truck[]
  users                       User[]
}

model User {
  id               String                  @id @default(uuid())
  email            String                  @unique
  passwordHash     String
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  companyId        String
  fullName         String?
  isActive         Boolean                 @default(true)
  role             UserRole                @default(DISPATCHER)
  callNotes        CallNote[]
  customers        Customer[]
  dashboardLayouts DashboardWidgetLayout[]
  documents        Document[]
  expenses         Expense[]
  loads            Load[]                  @relation("UserLoads")
  tasksAssigned    Task[]                  @relation("UserTasks")
  company          Company                 @relation(fields: [companyId], references: [id])
}

model Customer {
  id           String         @id @default(uuid())
  userId       String
  name         String
  type         String?
  mcNumber     String?
  email        String?
  phone        String?
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  addressLine1 String?
  addressLine2 String?
  city         String?
  companyId    String
  companyNotes String?
  convertedAt  DateTime?
  country      String?        @default("US")
  daysToPay    Int?
  deletedAt    DateTime?
  dormantAt    DateTime?
  leadStatus   LeadStatus?
  postalCode   String?
  state        String?
  status       CustomerStatus @default(PROSPECT)
  billingEmail String?
  creditHold   Boolean        @default(false)
  creditLimit  Int?
  portalUrl    String?
  callNotes    CallNote[]
  contacts     Contact[]
  company      Company        @relation(fields: [companyId], references: [id])
  user         User           @relation(fields: [userId], references: [id])
  documents    Document[]     @relation("CustomerDocuments")
  emailLogs    EmailLog[]
  invoices     Invoice[]
  loads        Load[]
  payments     Payment[]
  tasks        Task[]         @relation("CustomerTasks")
  rentedTrailers Trailer[]    @relation("RentedTrailers")
}

model CallNote {
  id         String   @id @default(uuid())
  userId     String
  customerId String
  content    String
  createdAt  DateTime @default(now())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model Load {
  id                String        @id @default(uuid())
  userId            String
  broker            String?
  rate              Int
  miles             Int
  fuelCost          Int
  lumper            Int?
  tolls             Int?
  otherCosts        Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  customerId        String?
  commodity         String?
  companyId         String
  deletedAt         DateTime?
  deliveryDate      DateTime?
  equipment         EquipmentType @default(DRY_VAN)
  invoicedAt        DateTime?
  isPaid            Boolean       @default(false)
  isSoftDeleted     Boolean       @default(false)
  isTeam            Boolean       @default(false)
  loadValue         Int?
  paidAt            DateTime?
  pickupDate        DateTime?
  status            LoadStatus    @default(DRAFT)
  temperature       Float?
  trailerId         String?
  truckId           String?
  detentionHours    Int?
  externalReference String?
  layoverDays       Int?
  loadNumber        String?
  tonuReason        String?
  documents         Document[]    @relation("LoadDocuments")
  expenses          Expense[]
  invoiceLinks      InvoiceLoad[]
  company           Company       @relation(fields: [companyId], references: [id])
  customer          Customer?     @relation(fields: [customerId], references: [id])
  trailer           Trailer?      @relation(fields: [trailerId], references: [id])
  truck             Truck?        @relation(fields: [truckId], references: [id])
  user              User          @relation("UserLoads", fields: [userId], references: [id])
  loadDrivers       LoadDriver[]
  stops             LoadStop[]
  tasks             Task[]        @relation("LoadTasks")
}

model LoadStop {
  id           String    @id @default(uuid())
  loadId       String
  sequence     Int
  type         StopType
  locationId   String?
  name         String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?   @default("US")
  scheduledAt  DateTime?
  arrivedAt    DateTime?
  departedAt   DateTime?
  bolNumber    String?
  pickupNumber String?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  load         Load      @relation(fields: [loadId], references: [id])
  location     Location? @relation(fields: [locationId], references: [id])
}

model LoadDriver {
  id       String  @id @default(uuid())
  loadId   String
  driverId String
  role     String?
  driver   Driver  @relation(fields: [driverId], references: [id])
  load     Load    @relation(fields: [loadId], references: [id])
}

model Driver {
  id              String       @id @default(uuid())
  companyId       String
  firstName       String
  lastName        String
  driverCode      String?      @unique
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  hireDate        DateTime?
  licenseNumber   String?
  licenseState    String?
  terminationDate DateTime?
  documents       Document[]   @relation("DriverDocuments")
  company         Company      @relation(fields: [companyId], references: [id])
  loadAssignments LoadDriver[]
}

model Truck {
  id             String      @id @default(uuid())
  companyId      String
  unitNumber     String
  vin            String?     @unique
  year           Int?
  make           String?
  model          String?
  type           String?
  status         TruckStatus @default(ACTIVE)
  condition      String?
  inactiveReason String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  lastPmAt       DateTime?
  monthlyPayment Int?
  odometer       Int?
  purchasePrice  Int?
  documents      Document[]  @relation("TruckDocuments")
  expenses       Expense[]
  loads          Load[]
  trailers       Trailer[]
  company        Company     @relation(fields: [companyId], references: [id])
}

model Trailer {
  id              String        @id @default(uuid())
  companyId       String
  trailerNumber   String
  year            Int?
  type            TrailerType   @default(DRY_VAN)
  lengthFeet      Int?
  status          TrailerStatus @default(ACTIVE)
  condition       String?
  inactiveReason  String?
  isReefer        Boolean       @default(false)
  hasAirChute     Boolean       @default(false)
  airChuteType    String?
  assignedTruckId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // rental fields
  isRentedOut        Boolean    @default(false)
  rentalRateMonthly  Int?
  rentedToCustomerId String?

  documents       Document[]    @relation("TrailerDocuments")
  expenses        Expense[]
  loads           Load[]
  assignedTruck   Truck?        @relation(fields: [assignedTruckId], references: [id])
  company         Company       @relation(fields: [companyId], references: [id])
  rentedToCustomer Customer?    @relation("RentedTrailers", fields: [rentedToCustomerId], references: [id])
}

model Location {
  id            String     @id @default(uuid())
  companyId     String
  name          String
  isShipper     Boolean    @default(true)
  isReceiver    Boolean    @default(true)
  addressLine1  String?
  addressLine2  String?
  city          String?
  state         String?
  postalCode    String?
  country       String?    @default("US")
  shippingHours String?
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  contacts      Contact[]
  stops         LoadStop[]
  company       Company    @relation(fields: [companyId], references: [id])
}

model Contact {
  id         String    @id @default(uuid())
  companyId  String
  customerId String?
  locationId String?
  name       String
  role       String?
  email      String?
  phone      String?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  company    Company   @relation(fields: [companyId], references: [id])
  customer   Customer? @relation(fields: [customerId], references: [id])
  location   Location? @relation(fields: [locationId], references: [id])
}

model Expense {
  id             String          @id @default(uuid())
  userId         String
  amount         Int
  description    String?
  incurredAt     DateTime        @default(now())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  categoryGroup  String?
  categoryKey    String?
  isRecurring    Boolean         @default(false)
  label          String?
  recurrenceFreq RecurrenceFreq?
  companyId      String
  loadId         String?
  trailerId      String?
  truckId        String?
  company        Company         @relation(fields: [companyId], references: [id])
  load           Load?           @relation(fields: [loadId], references: [id])
  trailer        Trailer?        @relation(fields: [trailerId], references: [id])
  truck          Truck?          @relation(fields: [truckId], references: [id])
  user           User            @relation(fields: [userId], references: [id])
}

model Invoice {
  id                    String        @id @default(uuid())
  companyId             String
  customerId            String
  invoiceNumber         String
  externalInvoiceNumber String?
  issueDate             DateTime
  dueDate               DateTime?
  subtotal              Int
  factoringFee          Int?
  total                 Int
  status                InvoiceStatus @default(DRAFT)
  isFactored            Boolean       @default(false)
  notes                 String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  emailLogs             EmailLog[]    @relation("InvoiceEmailLogs")
  company               Company       @relation(fields: [companyId], references: [id])
  customer              Customer      @relation(fields: [customerId], references: [id])
  lines                 InvoiceLine[]
  loadLinks             InvoiceLoad[]
  payments              Payment[]
  tasks                 Task[]        @relation("InvoiceTasks")
}

model InvoiceLine {
  id          String  @id @default(uuid())
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitAmount  Int
  total       Int
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
}

model InvoiceLoad {
  id        String  @id @default(uuid())
  invoiceId String
  loadId    String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])
  load      Load    @relation(fields: [loadId], references: [id])
}

model Payment {
  id         String        @id @default(uuid())
  companyId  String
  customerId String
  invoiceId  String
  amount     Int
  method     PaymentMethod @default(ACH)
  receivedAt DateTime
  notes      String?
  createdAt  DateTime      @default(now())
  company    Company       @relation(fields: [companyId], references: [id])
  customer   Customer      @relation(fields: [customerId], references: [id])
  invoice    Invoice       @relation(fields: [invoiceId], references: [id])
}

model Task {
  id                String     @id @default(uuid())
  companyId         String
  userId            String
  type              TaskType
  status            TaskStatus @default(PENDING)
  relatedCustomerId String?
  relatedLoadId     String?
  relatedInvoiceId  String?
  dueAt             DateTime?
  completedAt       DateTime?
  notes             String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  company           Company    @relation(fields: [companyId], references: [id])
  relatedCustomer   Customer?  @relation("CustomerTasks", fields: [relatedCustomerId], references: [id])
  relatedInvoice    Invoice?   @relation("InvoiceTasks", fields: [relatedInvoiceId], references: [id])
  relatedLoad       Load?      @relation("LoadTasks", fields: [relatedLoadId], references: [id])
  user              User       @relation("UserTasks", fields: [userId], references: [id])
}

model EmailTemplate {
  id        String     @id @default(uuid())
  companyId String
  name      String
  slug      String     @unique
  subject   String
  htmlBody  String
  textBody  String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  emailLogs EmailLog[]
  company   Company    @relation(fields: [companyId], references: [id])
}

model EmailLog {
  id                String         @id @default(uuid())
  companyId         String
  templateId        String?
  toEmail           String
  subject           String
  bodyPreview       String?
  status            EmailStatus    @default(QUEUED)
  sentAt            DateTime?
  errorMessage      String?
  relatedCustomerId String?
  relatedInvoiceId  String?
  createdAt         DateTime       @default(now())
  company           Company        @relation(fields: [companyId], references: [id])
  relatedCustomer   Customer?      @relation(fields: [relatedCustomerId], references: [id])
  relatedInvoice    Invoice?       @relation("InvoiceEmailLogs", fields: [relatedInvoiceId], references: [id])
  template          EmailTemplate? @relation(fields: [templateId], references: [id])
}

model MetricSnapshot {
  id          String     @id @default(uuid())
  companyId   String
  periodStart DateTime
  periodEnd   DateTime
  metricType  MetricType
  valueNumber Float
  payloadJson String?
  createdAt   DateTime   @default(now())
  company     Company    @relation(fields: [companyId], references: [id])
}

model ExpansionReadinessSnapshot {
  id                String   @id @default(uuid())
  companyId         String
  calculatedAt      DateTime
  score             Int
  recommendedAction String?
  inputsJson        String?
  createdAt         DateTime @default(now())
  company           Company  @relation(fields: [companyId], references: [id])
}

model DashboardWidgetLayout {
  id        String   @id @default(uuid())
  userId    String
  widgetId  String
  x         Int
  y         Int
  w         Int
  h         Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, widgetId])
}

model Document {
  id         String    @id @default(uuid())
  companyId  String
  userId     String?
  loadId     String?
  customerId String?
  driverId   String?
  truckId    String?
  trailerId  String?
  fileName   String
  fileType   String?
  fileSize   Int?
  storageKey String
  createdAt  DateTime  @default(now())
  company    Company   @relation(fields: [companyId], references: [id])
  customer   Customer? @relation("CustomerDocuments", fields: [customerId], references: [id])
  driver     Driver?   @relation("DriverDocuments", fields: [driverId], references: [id])
  load       Load?     @relation("LoadDocuments", fields: [loadId], references: [id])
  trailer    Trailer?  @relation("TrailerDocuments", fields: [trailerId], references: [id])
  truck      Truck?    @relation("TruckDocuments", fields: [truckId], references: [id])
  user       User?     @relation(fields: [userId], references: [id])
}

enum UserRole {
  OWNER
  ADMIN
  DISPATCHER
  DRIVER
  ACCOUNTING
  VIEW_ONLY
}

enum CustomerStatus {
  PROSPECT
  ACTIVE
  DORMANT
}

enum LeadStatus {
  HOT
  WARM
  COLD
  LOST
  UNKNOWN
}

enum LoadStatus {
  DRAFT
  BOOKED
  IN_TRANSIT
  DELIVERED
  INVOICED
  PAID
  CANCELLED
  TONU
}

enum StopType {
  PICKUP
  DELIVERY
}

enum EquipmentType {
  DRY_VAN
  REEFER
  FLATBED
  STEP_DECK
  POWER_ONLY
  OTHER
}

enum TrailerType {
  DRY_VAN
  REEFER
  FLATBED
  STEP_DECK
  OTHER
}

enum TruckStatus {
  ACTIVE
  IN_SHOP
  INACTIVE
  RETIRED
}

enum TrailerStatus {
  ACTIVE
  IN_SHOP
  INACTIVE
  RETIRED
}

enum InvoiceStatus {
  DRAFT
  SENT
  OVERDUE
  PAID
  CANCELLED
}

enum PaymentMethod {
  ACH
  CHECK
  FACTORING
  CASH
  OTHER
}

enum EmailStatus {
  QUEUED
  SENT
  FAILED
}

enum TaskType {
  CALL_CUSTOMER
  FOLLOW_UP_PROSPECT
  COLLECT_PAYMENT
  REVIEW_DORMANT_CUSTOMER
  REVIEW_DORMANT_PROSPECT
  REVIEW_EXPANSION_READINESS
  CUSTOM
}

enum TaskStatus {
  PENDING
  DONE
  DISMISSED
}

enum MetricType {
  REVENUE_30D
  PROFIT_30D
  RPM_30D
  UTILIZATION_30D
  FUEL_PCT_30D
  AR_OUTSTANDING
  CUSTOMER_CONCENTRATION
  CUSTOM
}

enum RecurrenceFreq {
  WEEKLY
  BIWEEKLY
  MONTHLY
  ANNUAL
}
